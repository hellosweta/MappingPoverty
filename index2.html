<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link rel="stylesheet" type="text/css" href="./css/reset.css">
  <link rel="stylesheet" type="text/css" href="./css/stylesheet.css">
  <link href="https://fonts.googleapis.com/css?family=Lora" rel="stylesheet">
  <div class="nav-bar">
    <h1 class="title">Mapping Poverty in America</h1>
    <h2 class="subtitle">Using Census Small Area Income and Poverty Estimates (SAIPE) to Show Changes in Where the Poor Live</h2>
  </div>
</head>
<div class="">
   <select id="dropdown"></select>
   <div id = "tooltip">
       <h3><span id = "neighborhood">&nbsp;</span></h3>
       <h5><span id = "datum">&nbsp;</span></h5>
   </div>
  <div id="map"></div>
</div>
<div class="about-modal">
  <h1>About</h1>
</div>
<svg width="960" height="600" class-"us-map"></svg>
<!-- <script type="text/javascript" src="./lib/queue_func.js"> -->

</script>
  <script type="text/javascript" src="./lib/d3.v4.min.js"></script>
  <script src="./lib/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <!-- <script src="./lib/d3.geo.zoom.js"></script> -->
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="./lib/d3.scale.chromatic.v1.min.js"></script>
  <script src="./lib/queue.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <!-- <script src="./js/main.js"></script> -->

<script type="text/javascript">
// create an svg element

// var zoom = d3.behavior.zoom()
//     .scaleExtent([1, 10])
//     .on("zoom", zoomed);

let width;
let height;
let projection;
let path;
let graticule;
let svg;
let year = 2015;
// let attributeArray = []currentAttribute = 0, playing = false;

const init = () => {
  setMap();
  populationDropdown();
  setKey();
  loadData(year)
  processData();
}
const setMap = () => {
  width = 960;
  height = 600;
  svg = d3.select("#map").append("svg")
  .attr("width", width)
  .attr("height", height);

}

// const width = svg.attr("width");
// const height = svg.attr("height");


const PovertyEstimates = d3.map();
path = d3.geoPath();


const x = d3.scaleLinear()
    .domain([3, 50])
    .rangeRound([600, 860]);

const color = d3.scaleThreshold()
    // .domain(d3.range(3, 50))
    .domain([0, 10, 20, 30, 40])
    .range(d3.schemeBlues[5]);


const setKey = () => {
  const g = svg.append("g")
  .attr("class", "key")
  .attr("transform", "translate(0,40)")

  g.selectAll("rect")
  .data(color.range().map( d => {
    d = color.invertExtent(d);
    if (d[0] == null) d[0] = x.domain()[0];
    if (d[1] == null) d[1] = x.domain()[1];
    return d;
  }))
  .enter().append("rect")
  .attr("height", 8)
  .attr("x", d => x(d[0]))
  .attr("width", d => x(d[1]) - x(d[0]))
  .attr("fill", d => color(d[0]))

  g.append("text")
  .attr("class", "caption")
  .attr("x", x.range()[0])
  .attr("y", -10)
  .attr("fill", "#000")
  .attr("text-anchor", "start")
  .attr("font-weight", "bold")
  .text("Poverty Rate");

  g.call(d3.axisBottom(x)
  .tickSize(13)
  .tickFormat((x, i) => ( i ? x : x + "%" ))
  .tickValues(color.domain()))
  .select(".domain")
  .remove();

}

const years = [2015, 2014, 2013]

const populationDropdown = () => {
  d3.select("#dropdown")
       .selectAll("option")
       .data(years)
       .enter()
       .append("option")
       .attr("value", year => year)
       .text(year => year);
}
const dropDown = d3.select("#dropdown");
  dropDown.on("change", () => {
  loadData(d3.event.target.value)


});

const processData = (error, us) => {
  if (error) throw error;

  svg.append("g")
    .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
    // .transition()
    // .duration(700)
    .attr("fill", d => {
      d.county = PovertyEstimates.get(`County${d.id}`)
      d.state = PovertyEstimates.get(`State${d.id}`)
      return color(d.rate = PovertyEstimates.get(d.id)) })
    .attr("d", path)
    .on("mouseover", (d) =>  displayData(d))
    .on("mouseout", hideData())
    .append("title")
    .text(d => {
      return(`${d.county}, ${d.state}
      Poverty Rate: ${d.rate}%`)
    })


  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, (a, b) => ( a !== b ) ))
      .attr("class", "states")
      .attr("d", path)

}
const displayData = (d) => {

  d3.select("#neighborhood")
              .text(`${d.county}, ${d.state}`)

  d3.select("#datum")
   .text(`Poverty Rate: ${d.rate}%`);
}

const hideData = () => {
  d3.select("#neighborhood")
           .text("\u00A0");

  d3.select("#datum")
           .text("\u00A0");
}
const loadData = (year) => {
  let key = `rate${year}`
  d3.queue()
  .defer(d3.json, "https://d3js.org/us-10m.v1.json")
  .defer(d3.tsv, "../data/dummydata.tsv", d => {
    return (PovertyEstimates.set(d.id, d[key]).set(`State${d.id}`, d.State).set(`County${d.id}`, d.Area_Name))
    // makes map ^^
  })
  .await(processData);

}
// function animateMap() {
//   const timer;  // create timer object
//   d3.select('#play')
//     .on('click', function() {  // when user clicks the play button
//       if (playing == false) {  // if the map is currently playing
//         timer = setInterval(function(){   // set a JS interval
//           if(currentAttribute < attributeArray.length-1) {
//               currentAttribute +=1;  // increment the current attribute counter
//           } else {
//               currentAttribute = 0;  // or reset it to zero
//           }
//           sequenceMap();  // update the representation of the map
//           d3.select('#clock').html(attributeArray[currentAttribute]);  // update the clock
//         }, 2000);
//
//         d3.select(this).html('stop');  // change the button label to stop
//         playing = true;   // change the status of the animation
//       } else {    // else if is currently playing
//         clearInterval(timer);   // stop the animation by clearing the interval
//         d3.select(this).html('play');   // change the button label to play
//         playing = false;   // change the status again
//       }
//   });
// }

window.onload = init();

</script>
