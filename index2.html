<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link rel="stylesheet" type="text/css" href="./css/reset.css">
  <link rel="stylesheet" type="text/css" href="./css/stylesheet.css">
  <link href="https://fonts.googleapis.com/css?family=Lora" rel="stylesheet">
  <div class="nav-bar">
    <h1 class="title">Mapping Poverty in America</h1>
    <h2 class="subtitle">Using Census Small Area Income and Poverty Estimates (SAIPE) to Show Changes in Where the Poor Live</h2>
  </div>
</head>
<body>
  <div class="content">

    <div class="wrapper">
      <div id="map"></div>
    </div>
    <div class="about-modal">
      <div id="tooltip">
        <select id="dropdown"></select>
        <h3><span id = "neighborhood">&nbsp;</span></h3>
        <h5><span id = "datum">&nbsp;</span></h5>
      </div>
      <p class="about-text">Using d3.js and census data, this choropleth map shows the estimated percent of people of all ages in poverty. Use the dropdown above to toggle through years to see changing demographics through time. This project eventually aims to examine if poverty is becoming increasingly  concentrated in counties as able and educated workforce move to more urban areas</p>
    </div>
  </div>
</body>

<!-- <script type="text/javascript" src="./lib/queue_func.js"> -->

</script>
  <script type="text/javascript" src="./lib/d3.v4.min.js"></script>
  <script src="./lib/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <!-- <script src="./lib/d3.geo.zoom.js"></script> -->
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="./lib/d3.scale.chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <!-- <script src="./js/main.js"></script> -->

<script type="text/javascript">

let width;
let height;
let projection;
let path;
let graticule;
let svg;
let year = 2015;
let z;
let active = d3.select(null);

const init = () => {
  setMap();
  populationDropdown();
  setZoom();
  setKey();
  loadData(year)
}
const setMap = () => {
  width = 960;
  height = 600;
  svg = d3.select("#map").append("svg")
  .attr("width", width)
  .attr("height", height)
  .on("click", stopped, true);


svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", reset);

}

const zoomed = () => {
  console.log("zoomed");
  z.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  z.attr("transform", d3.event.transform);
}
const zoom = () => {
  d3.zoom()
  .scaleExtent([1,8])
  .on("zoom", zoomed)
}

const setZoom = () => {
  z = svg.append("z")
  svg.call(zoom)
}


const PovertyEstimates = d3.map();
path = d3.geoPath();


const x = d3.scaleLinear()
    .domain([3, 50])
    .rangeRound([600, 860]);

const color = d3.scaleThreshold()
    // .domain(d3.range(3, 50))
    .domain([10, 20, 30, 40, 60])
    .range(d3.schemeBuPu[5]);


const setKey = () => {
  const g = svg.append("g")
  .attr("class", "key")
  .attr("transform", "translate(0,23)")

  g.selectAll("rect")
  .data(color.range().map( d => {
    d = color.invertExtent(d);
    if (d[0] == null) d[0] = x.domain()[0];
    if (d[1] == null) d[1] = x.domain()[1];
    return d;
  }))
  .enter().append("rect")
  .attr("height", 8)
  .attr("x", d => x(d[0]))
  .attr("width", d => x(d[1]) - x(d[0]))
  .attr("fill", d => color(d[0]))

  g.append("text")
  .attr("class", "caption")
  .attr("x", x.range()[0])
  .attr("y", -10)
  .attr("fill", "#000")
  .attr("text-anchor", "start")
  .attr("font-weight", "bold")
  .text("Poverty Rate");

  g.call(d3.axisBottom(x)
  .tickSize(13)
  .tickFormat((x, i) => ( i ? x : x + "%" ))
  .tickValues(color.domain()))
  .select(".domain")
  .remove();

}

const years = [2015, 2014, 2013]

const populationDropdown = () => {
  d3.select("#dropdown")
       .selectAll("option")
       .data(years)
       .enter()
       .append("option")
       .attr("value", year => year)
       .text(year => year);
}
const dropDown = d3.select("#dropdown");
  dropDown.on("change", () => {
  loadData(d3.event.target.value)


});

const processData = (error, us) => {
  if (error) throw error;
  svg.append("g")
    .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
    .attr("fill", d => {
      d.county = PovertyEstimates.get(`County${d.id}`)
      d.state = PovertyEstimates.get(`State${d.id}`)
      return color(d.rate = PovertyEstimates.get(d.id))
    }).attr("d", path)
    .on("mouseover", (d) =>  displayData(d))
    .on("mouseout", hideData())
    .append("title")
    .text(d => `${d.county}, ${d.state} Poverty Rate: ${d.rate}%`)


  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, (a, b) => ( a !== b ) ))
      .attr("class", "states")
      .on("click", clicked)
      .attr("d", path)

}
const displayData = (d) => {
  d3.select("#neighborhood")
    .text(`${d.county}, ${d.state}`)
  d3.select("#datum")
   .text(`Poverty Rate: ${d.rate}%`);
}

const hideData = () => {
  d3.select("#neighborhood")
    .text("\u00A0");

  d3.select("#datum")
    .text("\u00A0");
}
const loadData = (year) => {
  let key = `rate${year}`
  d3.queue()
  .defer(d3.json, "https://d3js.org/us-10m.v1.json")
  .defer(d3.tsv, "./data/dummydata.tsv", d => (PovertyEstimates.set(d.id, d[key]).set(`State${d.id}`, d.State).set(`County${d.id}`, d.Area_Name)))
  .await(processData);

}
function clicked(d) {
  if (active.node() === this) return reset();
  active.classed("active", false);
  active = d3.select(this).classed("active", true);

  var bounds = path.bounds(d),
      dx = bounds[1][0] - bounds[0][0],
      dy = bounds[1][1] - bounds[0][1],
      x = (bounds[0][0] + bounds[1][0]) / 2,
      y = (bounds[0][1] + bounds[1][1]) / 2,
      scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
      translate = [width / 2 - scale * x, height / 2 - scale * y];

  svg.transition()
      .duration(750)
      // .call(zoom.translate(translate).scale(scale).event); // not in d3 v4
      .call( zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) ); // updated for d3 v4
}

function reset() {
  active.classed("active", false);
  active = d3.select(null);

  svg.transition()
      .duration(750)
      // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
      .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4
}

function stopped() {
  if (d3.event.defaultPrevented) d3.event.stopPropagation();
}


window.onload = init();

</script>
