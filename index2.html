<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link rel="stylesheet" type="text/css" href="./css/stylesheet.css">

</head>

<style>



</style>
<svg width="960" height="600" class-"us-map"></svg>
<!-- <script type="text/javascript" src="./lib/queue_func.js"> -->

</script>
  <script type="text/javascript" src="./lib/d3.v4.min.js"></script>
  <script src="./lib/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <!-- <script src="./lib/d3.geo.zoom.js"></script> -->
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="./lib/d3.scale.chromatic.v1.min.js"></script>
  <script src="./lib/queue.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <!-- <script src="./js/main.js"></script> -->

<script type="text/javascript">
// create an svg element

// var zoom = d3.behavior.zoom()
//     .scaleExtent([1, 10])
//     .on("zoom", zoomed);

const svg = d3.select("svg")
.call(d3.zoom().on("zoom", function () {
svg.attr("transform", d3.event.transform)
}))



const width = svg.attr("width");
const height = svg.attr("height");

var PovertyEstimates = d3.map();

var path = d3.geoPath();

// var div = d3.select("body").append("div")
//  .attr("class", "tooltip")
//  .style("opacity", 0);
// var zoom = d3.zoom()
//     .scaleExtent([1, 40])
//     .translateExtent([[-100, -100], [width + 90, height + 100]])
//     .on("zoom", move);
  // var zoom = d3.behavior.zoom()
  //     .scaleExtent([1, 8])
  //     .on("zoom", move);
  //

// function zoomed() {
//   svg.translate(d3.event.translate).scale(d3.event.scale);
// g.selectAll("path").attr("d", path);
// }

// function move() {
//
//   var t = d3.event.translate;
//   var s = d3.event.scale;
//   var h = height / 3;
//
//   // t[0] = Math.min(width / 2 * (s - 1), Math.max(width / 2 * (1 - s), t[0]));
//   // t[1] = Math.min(height / 2 * (s - 1) + h * s, Math.max(height / 2 * (1 - s) - h * s, t[1]));
//
//   zoom.translate(t);
//   g.style("stroke-width", 1 / s).attr("transform", "translate(" + t + ")scale(" + s + ")");
//
// }

// create a geo path - https://github.com/mbostock/d3/wiki/Geo-Paths

// var projection = d3.geo.albers()
// .rotate([-105, 0])
// .center([-10, 65])
// .parallels([52, 64])
// .scale(700)
// .translate([width / 2, height / 2]);
//
// var path = d3.geo.path().projection(projection);

    // .scaleExtent([1, 8])
    // .on("zoom", move);

const x = d3.scaleLinear()
    .domain([3, 50])
    .rangeRound([600, 860]);

const color = d3.scaleThreshold()
    // .domain(d3.range(3, 50))
    .domain([5, 10, 20, 30, 40])
    .range(d3.schemeBlues[5]);

// const color = d3.scale.threshold()
//     .domain([10, 20, 30, 40, 50, 60])
//     .range(["#f2f0f7", "#dadaeb", "#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]);


// const zoomed = () => {
//   container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
// }

// var zoom = d3.zoom()
//     .scaleExtent([1, 10])
//     .on("zoom", zoomed);

const g = svg.append("g")
    .attr("class", "key")
    .attr("transform", "translate(0,20)")

    // .call(zoom);


g.selectAll("rect")
  .data(color.range().map( d => {
    d = color.invertExtent(d);
    if (d[0] == null) d[0] = x.domain()[0];
    if (d[1] == null) d[1] = x.domain()[1];
    return d;
  }))
  .enter().append("rect")
    .attr("height", 8)
    .attr("x", d => x(d[0]))
    .attr("width", d => x(d[1]) - x(d[0]))
    .attr("fill", d => color(d[0]))

g.append("text")
    .attr("class", "caption")
    .attr("x", x.range()[0])
    .attr("y", -10)
    .attr("fill", "#000")
    .attr("text-anchor", "start")
    .attr("font-weight", "bold")
    .text("Poverty Rate");

g.call(d3.axisBottom(x)
    .tickSize(13)
    .tickFormat((x, i) => ( i ? x : x + "%" ))
    .tickValues(color.domain()))
  .select(".domain")
    .remove();

// let  PovertyEstimates = d3.geoAlbers()
//     .scale(170)
//     .rotate([100,0,0])
//     .translate([width/2, height/2])
//     .clipAngle(90);
//
// const path = d3.geo.path().projection(PovertyEstimates);
// var projection = d3.geo.albers()
// .rotate([-105, 0])
// .center([-10, 65])
// .parallels([52, 64])
// .scale(700)
// .translate([width / 2, height / 2]);
//
// var path = d3.geo.path().projection(projection);

const ready = (error, us) => {
  if (error) throw error;

  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
      .attr("fill", d => {
        return color(d.rate = PovertyEstimates.get(d.id)) })
      .attr("d", path)
    .append("title")
      .text(d => {
        return(`${PovertyEstimates.get("County")}, ${PovertyEstimates.get("State")} Poverty Rate: ${d.rate}%`)
      })
    // .on("mouseover", function(d) {
    //   d3.select(this).transition().duration(300).style("opacity", 1)
    //   div.transition().duration(300)
    //   .style("opacity", 1)
    //   div.text(d => (d.rate + "%work" ))
    //   .style("left", (d3.event.pageX) + "px")
    //   .style("top", (d3.event.pageY -30) + "px");
    // })

    g.append("g")
       .attr("id", "states")
     .selectAll("path")
       .data(topojson.feature(us, us.objects.states).features)
     .enter().append("path")
       .attr("d", path)
       .on("click", clicked);
  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, (a, b) => ( a !== b ) ))
      .attr("class", "states")
      .attr("d", path)

  // .on("mouseover", function(d) {
  //   d3.select(this).transition().duration(300).style("opacity", 1)
  //   .transition().duration(300)
  //   .style("opacity", 1)
  //   .text((d.rate) + "work")
  //   .style("left", (d3.event.pageX) + "px")
  //   .style("top", (d3.event.pageY -30) + "px");
  // })
  // .on("mouseout", function() {
  //   d3.select(this)
  //   .transition().duration(300)
  //   .style("opacity", 0.8);
  //   div.transition().duration(300)
  //   .style("opacity", 0);
  // });

  // const zoom = d3.geo.zoom()
  //   .projection(PovertyEstimates)
  //   .on("zoom.redraw", function() {
  //     d3.event.sourceEvent.preventDefault();
  //     svg.selectAll("path").attr("d", path);
  //
  //   })
};
// function zoomed() {
//   container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
// }
d3.queue()
  .defer(d3.json, "https://d3js.org/us-10m.v1.json")
  .defer(d3.tsv, "../data/PovertyEstimates.tsv", d => {
    return (PovertyEstimates.set(d.id, d.rate).set("State", d.State).set("County", d.Area_Name))

  })
  .await(ready);

</script>



<div class="about-modal">
  <h1>About</h1>
</div>
