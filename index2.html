<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link rel="stylesheet" type="text/css" href="./css/stylesheet.css">
</head>
<div class="">
  <div id="map"></div>
  <button id="play" type="button" name="button"></button>
  <span id="clock">year</span>
</div>
<div class="about-modal">
  <h1>About</h1>
</div>
<svg width="960" height="600" class-"us-map"></svg>
<!-- <script type="text/javascript" src="./lib/queue_func.js"> -->

</script>
  <script type="text/javascript" src="./lib/d3.v4.min.js"></script>
  <script src="./lib/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <!-- <script src="./lib/d3.geo.zoom.js"></script> -->
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="./lib/d3.scale.chromatic.v1.min.js"></script>
  <script src="./lib/queue.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <!-- <script src="./js/main.js"></script> -->

<script type="text/javascript">
// create an svg element

// var zoom = d3.behavior.zoom()
//     .scaleExtent([1, 10])
//     .on("zoom", zoomed);

let width;
let height;
let projection;
let path;
let graticule;
let svg;
// let attributeArray = []currentAttribute = 0, playing = false;

const init = () => {
  setMap();
  setKey();
  loadData();
  processData();
}
const setMap = () => {
  width = 960;
  height = 600;
  svg = d3.select("#map").append("svg")
  .attr("width", width)
  .attr("height", height);

}

// const width = svg.attr("width");
// const height = svg.attr("height");


const PovertyEstimates = d3.map();
path = d3.geoPath();


const x = d3.scaleLinear()
    .domain([3, 50])
    .rangeRound([600, 860]);

const color = d3.scaleThreshold()
    // .domain(d3.range(3, 50))
    .domain([5, 10, 20, 30, 40])
    .range(d3.schemeBlues[5]);


const setKey = () => {
  const g = svg.append("g")
  .attr("class", "key")
  .attr("transform", "translate(0,40)")

  g.selectAll("rect")
  .data(color.range().map( d => {
    d = color.invertExtent(d);
    if (d[0] == null) d[0] = x.domain()[0];
    if (d[1] == null) d[1] = x.domain()[1];
    return d;
  }))
  .enter().append("rect")
  .attr("height", 8)
  .attr("x", d => x(d[0]))
  .attr("width", d => x(d[1]) - x(d[0]))
  .attr("fill", d => color(d[0]))

  g.append("text")
  .attr("class", "caption")
  .attr("x", x.range()[0])
  .attr("y", -10)
  .attr("fill", "#000")
  .attr("text-anchor", "start")
  .attr("font-weight", "bold")
  .text("Poverty Rate");

  g.call(d3.axisBottom(x)
  .tickSize(13)
  .tickFormat((x, i) => ( i ? x : x + "%" ))
  .tickValues(color.domain()))
  .select(".domain")
  .remove();

}


const processData = (error, us) => {
  if (error) throw error;

  svg.append("rect2")
  .attr("class", "background")
  .attr("width", width)
  .attr("height", height)

  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
      .attr("fill", d => {
        d.county = PovertyEstimates.get(`County${d.id}`)
        d.state = PovertyEstimates.get(`State${d.id}`)
        return color(d.rate = PovertyEstimates.get(d.id)) })
      .attr("d", path)
    .append("title")
      .text(d => {
        return(`${d.county}, ${d.state}
        Poverty Rate: ${d.rate}%`)
      })

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, (a, b) => ( a !== b ) ))
      .attr("class", "states")
      .attr("d", path)

}

const loadData = () => {
  d3.queue()
  .defer(d3.json, "https://d3js.org/us-10m.v1.json")
  .defer(d3.tsv, "../data/PovertyEstimates.tsv", d => {
    return (PovertyEstimates.set(d.id, d.rate).set(`State${d.id}`, d.State).set(`County${d.id}`, d.Area_Name))
    // makes map ^^
  })
  .await(processData);

}
// function animateMap() {
//   const timer;  // create timer object
//   d3.select('#play')
//     .on('click', function() {  // when user clicks the play button
//       if (playing == false) {  // if the map is currently playing
//         timer = setInterval(function(){   // set a JS interval
//           if(currentAttribute < attributeArray.length-1) {
//               currentAttribute +=1;  // increment the current attribute counter
//           } else {
//               currentAttribute = 0;  // or reset it to zero
//           }
//           sequenceMap();  // update the representation of the map
//           d3.select('#clock').html(attributeArray[currentAttribute]);  // update the clock
//         }, 2000);
//
//         d3.select(this).html('stop');  // change the button label to stop
//         playing = true;   // change the status of the animation
//       } else {    // else if is currently playing
//         clearInterval(timer);   // stop the animation by clearing the interval
//         d3.select(this).html('play');   // change the button label to play
//         playing = false;   // change the status again
//       }
//   });
// }

window.onload = init();

</script>
